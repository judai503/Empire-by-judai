const used = new Set()

const handler = async (m, { conn, command, args }) => {

  // â”€â”€â”€â”€â”€ Anti duplicados â”€â”€â”€â”€â”€
  if (m.isBaileys) return
  if (used.has(m.key.id)) return
  used.add(m.key.id)
  setTimeout(() => used.delete(m.key.id), 5000)

  // â”€â”€â”€â”€â”€ Bloquear canales â”€â”€â”€â”€â”€
  if (m.chat.endsWith('@newsletter')) return

  // â”€â”€â”€â”€â”€ Obtener usuario si aplica â”€â”€â”€â”€â”€
  let user = m.mentionedJid[0] || (m.quoted ? m.quoted.sender : null)

  // â”€â”€â”€â”€â”€ ADMIN ON / OFF â”€â”€â”€â”€â”€
  if (command === 'admin') {
    if (!args[0]) return m.reply('âŒ Usa: .admin on @user | .admin off @user')
    if (!user) return m.reply('âŒ Menciona o responde a un usuario.')

    let accion = args[0].toLowerCase()

    if (accion === 'on' || accion === 'dar') {
      await conn.groupParticipantsUpdate(m.chat, [user], 'promote')
      return m.reply('âœ… Usuario promovido a admin.')
    }

    if (accion === 'off' || accion === 'quitar') {
      await conn.groupParticipantsUpdate(m.chat, [user], 'demote')
      return m.reply('âŒ Admin removido.')
    }

    return m.reply('âŒ OpciÃ³n invÃ¡lida.')
  }

  // â”€â”€â”€â”€â”€ ABRIR GRUPO â”€â”€â”€â”€â”€
  if (['abrirgrupo','grupoabrir','abrir'].includes(command)) {
    await conn.groupSettingUpdate(m.chat, 'not_announcement')
    return m.reply('ğŸ”“ Grupo abierto.')
  }

  // â”€â”€â”€â”€â”€ CERRAR GRUPO â”€â”€â”€â”€â”€
  if (['cerrar','cerrargrupo','grupocerrar'].includes(command)) {
    await conn.groupSettingUpdate(m.chat, 'announcement')
    return m.reply('ğŸ”’ Grupo cerrado.')
  }

  // â”€â”€â”€â”€â”€ BORRAR MENSAJE â”€â”€â”€â”€â”€
  if (['d','delete','borrar'].includes(command)) {
    if (!m.quoted) return m.reply('âŒ Responde al mensaje que quieres borrar.')

    try {
      const key = {
        remoteJid: m.chat,
        fromMe: false,
        id: m.quoted.id,
        participant: m.quoted.sender
      }

      // borrar mensaje citado
      await conn.sendMessage(m.chat, { delete: key })

      // borrar comando
      await conn.sendMessage(m.chat, { delete: m.key })

    } catch (e) {
      console.error(e)
      return m.reply('âŒ No se pudo borrar el mensaje.')
    }
    return
  }

  // â”€â”€â”€â”€â”€ RESET LINK â”€â”€â”€â”€â”€
  if (['resetlink','r','nlink'].includes(command)) {
    await conn.groupRevokeInvite(m.chat)
    let code = await conn.groupInviteCode(m.chat)
    return m.reply(`ğŸ” Nuevo link:\nhttps://chat.whatsapp.com/${code}`)
  }

  // â”€â”€â”€â”€â”€ KICK / BAN â”€â”€â”€â”€â”€
  if (['kick','ban','alv'].includes(command)) {
    if (!user) return m.reply('âŒ Menciona o responde a un usuario.')
    await conn.groupParticipantsUpdate(m.chat, [user], 'remove')
    return m.reply('ğŸš« Usuario eliminado del grupo.')
  }
}

handler.help = ['admin','abrir','cerrar','delete','resetlink','kick']
handler.tags = ['grupo']

handler.command = [
  'admin',

  'abrirgrupo','grupoabrir','abrir',
  'cerrar','cerrargrupo','grupocerrar',

  'd','delete','borrar',

  'resetlink','r','nlink',

  'kick','ban','alv'
]

handler.group = true
handler.admin = true
handler.botAdmin = true
handler.channel = false

export default handler
